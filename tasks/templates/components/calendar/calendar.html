{% extends "base.html" %}
{% load static %}

{% block title %}–ö–∞–ª–µ–Ω–¥–∞—Ä—å{% endblock title %}

{% block content %}

    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
    {#    Basic#}
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css' rel='stylesheet'/>

    {#    Premium#}
    {#    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js'></script>#}

    <script src='{% static 'js/fullcalendar-premium.min.js' %}'></script>


    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->

    <div class="px-3 py-3">

        <div class="container  px-4 py-4 rounded-4 border border-1">

            {% include "components/task/tasks_container_buttons.html" with show_active_task=tasks.show_active_task not_done_count=tasks.not_done_count  show_done_task=tasks.show_done_task  done_count=tasks.done_count  show_my_tasks_only=tasks.show_my_tasks_only tasks_due_today_count=tasks.tasks_due_today_count %}

            <div class="d-flex justify-content-start px-4 mt-3">
                {% include "components/task/create_task.html" %}
            </div>
            <div class="mt-4 px-4" id="calendar"></div>
        </div>

    </div>

    {% include 'components/task/edit_task_modal.html' %}


    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div id="task-content" class="modal-body">
                    ...
                </div>
            </div>
        </div>
    </div>

    <script>
        let calendarTaskModal;

        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            calendarTaskModal = new bootstrap.Modal(document.getElementById('taskModal'));

            const calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'ru',
                dayMaxEventRows: true, // for all non-TimeGrid views
                views: {
                    timeGrid: {
                        dayMaxEventRows: 10 // adjust to 6 only for timeGridWeek/timeGridDay
                    }
                },
                firstDay: 1,
                height: '85vh',

                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'listWeek,dayGridMonth,multiMonthYear'
                },
                initialView: 'dayGridMonth',
                themeSystem: "bootstrap5",
                displayEventTime: true,

                businessHours: [
                    {
                        daysOfWeek: [1, 2, 3, 4, 5],
                        startTime: '08:30',
                        endTime: '17:30'
                    },
                ],

                eventClick: function (info) {
                    const currentFullPath = window.location.pathname+window.location.search; // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π URL

                    const url = "/ajax/tasks/" + info.event.id + "/?referrer=" + encodeURIComponent(currentFullPath);

                    if (calendarTaskModal) {
                        calendarTaskModal.show();
                        modals.push(calendarTaskModal);
                        $("#task-content").load(url);
                    }
                },


                events: [
                    {% for task in tasks.tasks %}
                        {
                            title: '{{ task.header }}',
                            start: '{{ task.completion_time|date:"Y-m-d\TH:i:s" }}',
                            id: '{{ task.id }}',

                            classNames: ['taskCalendar',
                                {% if task.is_done %}
                                    'taskDone',
                                {% else %}
                                    {% if task.priority == 'CRITICAL' %}
                                        'taskCrit',
                                    {% elif task.priority == 'HIGH' %}
                                        'taskDanger',
                                    {% elif task.priority == 'MEDIUM' %}
                                        'taskWarning',
                                    {% elif task.priority == 'LOW' %}
                                        'taskInfo',
                                    {% endif %}
                                {% endif %}
                            ],
                            priority: '{{ task.priority }}',
                            isDone: '{{ task.is_done }}' // –î–æ–±–∞–≤–ª—è–µ–º is_done –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

                        },
                    {% endfor %}
                ],

                eventDidMount: function (info) {
                    let color;

                    // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç
                    if (info.event.extendedProps.isDone === 'True') {
                        color = '#32CD32'; // Green color for done tasks
                    } else {
                        // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –≤—ã–±–∏—Ä–∞–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
                        switch (info.event.extendedProps.priority) {
                            case 'CRITICAL':
                                color = '#FF0000'; // Red for critical
                                break;
                            case 'HIGH':
                                color = '#FF6347'; // Tomato for high
                                break;
                            case 'MEDIUM':
                                color = '#FFD700'; // Gold for medium
                                break;
                            case 'LOW':
                                color = '#1E90FF'; // DodgerBlue for low
                                break;
                            default:
                                color = 'gray'; // Default color if priority is not matched
                        }
                    }

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ä–∞–º–∫–∏ –∏ —Ñ–æ–Ω–∞ —Å–æ–±—ã—Ç–∏—è
                    info.el.style.borderColor = color;
                    info.el.style.borderWidth = '1px';
                    info.el.style.borderStyle = 'solid';
                    info.el.style.borderRadius = '7px';
                    info.el.style.backgroundColor = color; // Background color matches border
                },
                {#weekNumbers : 'true',#}
                {#weekText :'–ù–µ–¥–µ–ª—è ',#}

                buttonText: {
                    today: 'üè†Ô∏é',
                    month: '–ú–µ—Å—è—Ü',
                    week: '–ù–µ–¥–µ–ª—è',
                    day: '–î–µ–Ω—å',
                    year: '–ì–æ–¥',
                },
                editable: false,
                selectable: true
            });

            calendar.render();
        });
    </script>

    <script>
        function updateUrl() {
            {#const showActiveTasks = document.getElementById('showActiveTasksSwitch').checked;#}
            {#const showDoneTasks = document.getElementById('showDoneTasksSwitch').checked;#}
            const showMyTasksOnly = document.getElementById('showMyTasksOnlySwitch') ? document.getElementById('showMyTasksOnlySwitch').checked : null;
            const sortOrder = document.getElementById('sortOrderSwitch') ? (document.getElementById('sortOrderSwitch').checked ? 'desc' : 'asc') : null;

            const currentUrl = new URL(window.location.href);
            const params = new URLSearchParams(currentUrl.search);

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            {#params.set('show_active_task', showActiveTasks);#}
            {#params.set('show_done_task', showDoneTasks);#}
            if (showMyTasksOnly !== null) params.set('show_my_tasks_only', showMyTasksOnly);
            if (sortOrder !== null) params.set('sort_order', sortOrder);

            // –û–±–Ω–æ–≤–ª—è–µ–º URL
            window.location.search = params.toString();
        }
    </script>
    <script>
        function toggleFilter(filterName, currentValue, secondFilterName = null, secondFilterValue = null) {
            const urlParams = new URLSearchParams(window.location.search);

            // –ï—Å–ª–∏ –æ–±–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–µ—Ä–µ–¥–∞–Ω—ã (–¥–ª—è —Å—Ä–µ–¥–Ω–µ–π –∫–Ω–æ–ø–∫–∏), —Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ–±–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –≤ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (secondFilterName && secondFilterValue !== null) {
                // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∏–ª—å—Ç—Ä –≤—ã–∫–ª—é—á–µ–Ω, –≤–∫–ª—é—á–∞–µ–º –æ–±–∞
                if (currentValue === false || secondFilterValue === false) {
                    urlParams.set(filterName, "true");
                    urlParams.set(secondFilterName, "true");
                } else {
                    // –ï—Å–ª–∏ –æ–±–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –≤–∫–ª—é—á–µ–Ω—ã, –≤—ã–∫–ª—é—á–∞–µ–º –æ–±–∞
                    urlParams.set(filterName, "false");
                    urlParams.set(secondFilterName, "false");
                }
            } else {
                // –ï—Å–ª–∏ –≤–∫–ª—é—á–∞–µ–º –æ–¥–∏–Ω —Ñ–∏–ª—å—Ç—Ä (–∫–Ω–æ–ø–∫–∏ –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–ª–∏ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ)
                if (currentValue === true) {
                    urlParams.set(filterName, "false");
                } else {
                    urlParams.set(filterName, "true");
                    // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Ç–æ—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä, –µ—Å–ª–∏ –≤–∫–ª—é—á–∞–µ–º —ç—Ç–æ—Ç
                    if (filterName === "show_active_task") {
                        urlParams.set("show_done_task", "false");
                    } else if (filterName === "show_done_task") {
                        urlParams.set("show_active_task", "false");
                    }
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º URL –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            window.location.href = "?" + urlParams.toString();
        }
    </script>



{% endblock %}
